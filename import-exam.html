<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Importar Examen ENARM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Fuente opcional para que se vea decente -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 900px;
      margin: 32px auto;
      background: #020617;
      border-radius: 12px;
      padding: 20px 22px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 12px 30px rgba(15,23,42,0.5);
    }

    h1 {
      font-size: 20px;
      margin-bottom: 6px;
    }

    .subtitle {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 16px;
    }

    .status {
      font-size: 13px;
      margin-bottom: 16px;
      padding: 8px 10px;
      border-radius: 8px;
    }

    .status.error {
      background: rgba(220, 38, 38, 0.12);
      border: 1px solid rgba(248, 113, 113, 0.4);
      color: #fecaca;
    }

    .status.ok {
      background: rgba(22, 163, 74, 0.12);
      border: 1px solid rgba(74, 222, 128, 0.4);
      color: #bbf7d0;
    }

    label {
      font-size: 13px;
      display: block;
      margin-bottom: 6px;
    }

    textarea {
      width: 100%;
      min-height: 260px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      padding: 10px 12px;
      font-size: 13px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: #020617;
      color: #e5e7eb;
      resize: vertical;
      outline: none;
    }

    textarea:focus {
      border-color: #60a5fa;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.6);
    }

    .btn-row {
      margin-top: 14px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    button {
      padding: 9px 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: #f9fafb;
      box-shadow: 0 10px 20px rgba(37, 99, 235, 0.35);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }

    .btn-secondary {
      background: #4b5563;
      color: #e5e7eb;
    }

    .hint {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 6px;
      line-height: 1.4;
    }

    pre {
      margin-top: 16px;
      background: #020617;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      font-size: 12px;
      max-height: 260px;
      overflow: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>Importar examen ENARM (JSON)</h1>
    <p class="subtitle">
      1) Inicia sesión como <strong>admin</strong> en <code>index.html</code>.<br>
      2) Luego abre esta página (<code>import-exam.html</code>) en la misma sesión.<br>
      3) Pega aquí el JSON del examen y pulsa “Importar examen”.
    </p>

    <div id="auth-status" class="status error">
      Verificando autenticación...
    </div>

    <label for="jsonInput">JSON del examen</label>
    <textarea id="jsonInput" placeholder="Pega aquí el JSON del examen..."></textarea>
    <div class="hint">
      Debe tener la estructura: <code>{ sectionName, examName, cases: [...] }</code><br>
      Cada <code>case</code> lleva su <code>caseText</code>, <code>specialty</code> y un arreglo <code>questions</code> con TODAS las preguntas de ese caso.
    </div>

    <div class="btn-row">
      <button id="btnImport" class="btn-primary" disabled>Importar examen</button>
      <button id="btnFillExample" class="btn-secondary" type="button">Poner ejemplo de Examen 76</button>
    </div>

    <pre id="log"></pre>
  </div>

  <!-- Firebase (MODULAR) CDN -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      doc,
      getDoc,
      getDocs,
      query,
      where,
      updateDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ==========================
    // CONFIGURACIÓN FIREBASE
    // ==========================
    const firebaseConfig = {
      apiKey: "AIzaSyDAGsmp2qwZ2VBBKIDpUF0NUElcCLsGanQ",
      authDomain: "simulacros-plataforma-enarm.firebaseapp.com",
      projectId: "simulacros-plataforma-enarm",
      storageBucket: "simulacros-plataforma-enarm.firebasestorage.app",
      messagingSenderId: "1012829203040",
      appId: "1:1012829203040:web:71de568ff8606a1c8d7105",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const authStatusEl = document.getElementById("auth-status");
    const jsonInput = document.getElementById("jsonInput");
    const btnImport = document.getElementById("btnImport");
    const btnFillExample = document.getElementById("btnFillExample");
    const logEl = document.getElementById("log");

    let currentUser = null;
    let isAdmin = false;

    function log(message) {
      const time = new Date().toLocaleTimeString();
      logEl.textContent += `[${time}] ${message}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    // ==========================
    // VERIFICAR QUE SEA ADMIN
    // ==========================
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        currentUser = null;
        isAdmin = false;
        authStatusEl.className = "status error";
        authStatusEl.textContent =
          "No hay sesión iniciada. Inicia sesión como ADMIN en index.html y vuelve a abrir esta página.";
        btnImport.disabled = true;
        return;
      }

      currentUser = user;
      try {
        const userDocRef = doc(db, "users", user.email);
        const snap = await getDoc(userDocRef);
        if (!snap.exists()) {
          isAdmin = false;
          authStatusEl.className = "status error";
          authStatusEl.textContent = `El usuario ${user.email} no tiene documento en 'users'.`;
          btnImport.disabled = true;
          return;
        }

        const data = snap.data();
        if (data.role !== "admin") {
          isAdmin = false;
          authStatusEl.className = "status error";
          authStatusEl.textContent = `El usuario ${user.email} no es admin (role actual: ${
            data.role || "sin definir"
          }).`;
          btnImport.disabled = true;
          return;
        }

        isAdmin = true;
        authStatusEl.className = "status ok";
        authStatusEl.textContent = `Autenticado como ADMIN: ${user.email}. Puedes importar exámenes.`;
        btnImport.disabled = false;
      } catch (err) {
        console.error(err);
        isAdmin = false;
        authStatusEl.className = "status error";
        authStatusEl.textContent = "Error verificando role de admin en 'users'. Revisa la consola.";
        btnImport.disabled = true;
      }
    });

    // ==========================
    // IMPORTAR EXAMEN DESDE JSON
    // ==========================
    async function importExamFromJson() {
      if (!isAdmin) {
        alert("Solo un admin puede importar exámenes.");
        return;
      }

      let parsed;
      try {
        parsed = JSON.parse(jsonInput.value);
      } catch (err) {
        alert("El JSON no es válido. Revisa comas, llaves y comillas.");
        log("Error al parsear JSON: " + err.message);
        return;
      }

      const sectionName = parsed.sectionName || null;
      const sectionIdFromJson = parsed.sectionId || null;
      const examName = parsed.examName || null;
      const cases = Array.isArray(parsed.cases) ? parsed.cases : [];
      const examIdFromJson = parsed.examId || null; // opcional para reutilizar examen exacto

      if (!examName || !cases.length) {
        alert("El JSON debe incluir 'examName' y un arreglo 'cases' con al menos 1 caso clínico.");
        log("JSON incompleto: falta examName o cases.");
        return;
      }

      btnImport.disabled = true;
      log("Iniciando importación...");

      try {
        // 1) RESOLVER SECTION
        let finalSectionId = sectionIdFromJson;

        if (!finalSectionId) {
          if (!sectionName) {
            throw new Error("Falta 'sectionId' o 'sectionName' en el JSON.");
          }

          // buscar sección existente con ese nombre
          const qSec = query(collection(db, "sections"), where("name", "==", sectionName));
          const snapSec = await getDocs(qSec);

          if (!snapSec.empty) {
            finalSectionId = snapSec.docs[0].id;
            log(`Sección existente reutilizada: "${sectionName}" (id: ${finalSectionId})`);
          } else {
            const secRef = await addDoc(collection(db, "sections"), {
              name: sectionName,
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp(),
            });
            finalSectionId = secRef.id;
            log(`Sección creada: "${sectionName}" (id: ${finalSectionId})`);
          }
        } else {
          log(`Se utilizará la sección existente con id: ${finalSectionId}`);
        }

        // 2) RESOLVER / CREAR EXAMEN
        let examRef;
        let examId;

        if (examIdFromJson) {
          // usar examen ya existente por ID
          examRef = doc(db, "exams", examIdFromJson);
          const exSnap = await getDoc(examRef);
          if (!exSnap.exists()) {
            throw new Error(`El examId ${examIdFromJson} no existe en 'exams'.`);
          }

          const exData = exSnap.data() || {};
          const updates = { updatedAt: serverTimestamp() };
          if (!exData.createdAt) {
            updates.createdAt = serverTimestamp();
          }
          await updateDoc(examRef, updates);

          examId = examIdFromJson;
          log(`Se usará examen EXISTENTE por examId: ${examIdFromJson}`);
        } else {
          // buscar examen por sectionId + name
          let existingExamId = null;

          if (finalSectionId && examName) {
            const qEx = query(
              collection(db, "exams"),
              where("sectionId", "==", finalSectionId),
              where("name", "==", examName)
            );
            const snapEx = await getDocs(qEx);
            if (!snapEx.empty) {
              existingExamId = snapEx.docs[0].id;
            }
          }
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Importar Examen ENARM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    body { font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,sans-serif; background:#0f172a; color:#e5e7eb; margin:0; padding:0; }
    .container { max-width:900px; margin:32px auto; background:#020617; border-radius:12px; padding:20px 22px; border:1px solid rgba(148,163,184,.4); box-shadow:0 12px 30px rgba(15,23,42,.5); }
    h1 { font-size:20px; margin-bottom:6px; }
    .subtitle { font-size:13px; color:#9ca3af; margin-bottom:16px; }
    .status { font-size:13px; margin-bottom:16px; padding:8px 10px; border-radius:8px; }
    .status.error { background:rgba(220,38,38,.12); border:1px solid rgba(248,113,113,.4); color:#fecaca; }
    .status.ok { background:rgba(22,163,74,.12); border:1px solid rgba(74,222,128,.4); color:#bbf7d0; }
    label { font-size:13px; display:block; margin-bottom:6px; }
    textarea { width:100%; min-height:260px; border-radius:10px; border:1px solid rgba(148,163,184,.5); padding:10px 12px; font-size:13px; font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; background:#020617; color:#e5e7eb; resize:vertical; outline:none; }
    textarea:focus { border-color:#60a5fa; box-shadow:0 0 0 1px rgba(37,99,235,.6); }
    input[type="text"] { width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(148,163,184,.5); background:#020617; color:#e5e7eb; outline:none; font-size:13px; }
    input[type="text"]:focus { border-color:#60a5fa; box-shadow:0 0 0 1px rgba(37,99,235,.6); }
    .btn-row { margin-top:14px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    button { padding:9px 16px; border-radius:8px; border:none; cursor:pointer; font-size:14px; font-weight:500; display:inline-flex; align-items:center; gap:6px; }
    .btn-primary { background:linear-gradient(135deg,#2563eb,#1d4ed8); color:#f9fafb; box-shadow:0 10px 20px rgba(37,99,235,.35); }
    .btn-primary:disabled { opacity:.5; cursor:not-allowed; box-shadow:none; }
    .btn-secondary { background:#4b5563; color:#e5e7eb; }
    .hint { font-size:12px; color:#9ca3af; margin-top:6px; line-height:1.4; }
    pre { margin-top:16px; background:#020617; padding:10px 12px; border-radius:10px; border:1px solid rgba(148,163,184,.4); font-size:12px; max-height:260px; overflow:auto; white-space:pre-wrap; word-wrap:break-word; }
    .divider { height:1px; background:rgba(148,163,184,.25); margin:16px 0; }
  </style>
</head>
<body>

  <div class="container">
    <h1>Importar examen ENARM (JSON)</h1>
    <p class="subtitle">
      1) Inicia sesión como <strong>admin</strong> en <code>index.html</code>.<br>
      2) Luego abre esta página (<code>import-exam.html</code>) en la misma sesión.<br>
      3) Pega aquí el JSON del examen y pulsa el botón que necesites.
    </p>

    <div id="auth-status" class="status error">Verificando autenticación...</div>

    <label for="topicInput">Tema del lote (para Banco caseBank)</label>
    <input id="topicInput" type="text" placeholder="Ej: apendicitis aguda, preeclampsia, hemorragia posparto..." />
    <div class="hint">
      Este campo SOLO aplica al botón “Importar lote a Banco (caseBank)”.<br>
      Si no lo pones, NO te deja importar al banco (porque es la clave de búsqueda).
    </div>

    <div class="divider"></div>

    <label for="jsonInput">JSON del examen</label>
    <textarea id="jsonInput" placeholder="Pega aquí el JSON del examen..."></textarea>
    <div class="hint">
      Estructura esperada: <code>{ sectionName, examName, cases: [...] }</code><br>
      Cada <code>case</code>: <code>caseText</code>, <code>specialty</code>, <code>questions</code> (todas las preguntas).
    </div>

    <div class="btn-row">
      <button id="btnImport" class="btn-primary" disabled>Importar examen (sections/exams/questions)</button>
      <button id="btnImportToBank" class="btn-primary" disabled>Importar lote a Banco (caseBank)</button>
      <button id="btnFillExample" class="btn-secondary" type="button">Poner ejemplo de Examen 76</button>
    </div>

    <pre id="log"></pre>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      doc,
      getDoc,
      getDocs,
      query,
      where,
      updateDoc,
      setDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ==========================
    // CONFIG FIREBASE
    // ==========================
    const firebaseConfig = {
      apiKey: "AIzaSyDAGsmp2qwZ2VBBKIDpUF0NUElcCLsGanQ",
      authDomain: "simulacros-plataforma-enarm.firebaseapp.com",
      projectId: "simulacros-plataforma-enarm",
      storageBucket: "simulacros-plataforma-enarm.firebasestorage.app",
      messagingSenderId: "1012829203040",
      appId: "1:1012829203040:web:71de568ff8606a1c8d7105",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ==========================
    // DOM
    // ==========================
    const authStatusEl = document.getElementById("auth-status");
    const topicInput = document.getElementById("topicInput");
    const jsonInput = document.getElementById("jsonInput");
    const btnImport = document.getElementById("btnImport");
    const btnImportToBank = document.getElementById("btnImportToBank");
    const btnFillExample = document.getElementById("btnFillExample");
    const logEl = document.getElementById("log");

    let currentUser = null;
    let isAdmin = false;

    function log(message) {
      const time = new Date().toLocaleTimeString();
      logEl.textContent += `[${time}] ${message}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    // ==========================
    // HELPERS: normalización + tokens
    // ==========================
    function normalizeLower(str) {
      return (str || "")
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "");
    }

    function tokenize(str, max = 20) {
      return normalizeLower(str)
        .replace(/[^a-z0-9\s]/g, " ")
        .split(/\s+/)
        .filter(Boolean)
        .slice(0, max);
    }

    // Hash simple estable (FNV-1a 32-bit) para dedupe sin crypto pesado
    function fnv1a32(str) {
      let h = 0x811c9dc5;
      for (let i = 0; i < str.length; i++) {
        h ^= str.charCodeAt(i);
        h = (h + ((h << 1) + (h << 4) + (h << 7) + (h << 8) + (h << 24))) >>> 0;
      }
      return ("0000000" + h.toString(16)).slice(-8);
    }

    function parseJsonOrThrow() {
      let parsed;
      try {
        parsed = JSON.parse(jsonInput.value);
      } catch (err) {
        throw new Error("JSON inválido: revisa comas, llaves y comillas.");
      }
      return parsed;
    }

    // ==========================
    // VERIFICAR ADMIN
    // ==========================
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        currentUser = null;
        isAdmin = false;
        authStatusEl.className = "status error";
        authStatusEl.textContent =
          "No hay sesión iniciada. Inicia sesión como ADMIN en index.html y vuelve a abrir esta página.";
        btnImport.disabled = true;
        btnImportToBank.disabled = true;
        return;
      }

      currentUser = user;

      try {
        const userDocRef = doc(db, "users", user.email);
        const snap = await getDoc(userDocRef);

        if (!snap.exists()) {
          isAdmin = false;
          authStatusEl.className = "status error";
          authStatusEl.textContent = `El usuario ${user.email} no tiene documento en 'users'.`;
          btnImport.disabled = true;
          btnImportToBank.disabled = true;
          return;
        }

        const data = snap.data();
        if (data.role !== "admin") {
          isAdmin = false;
          authStatusEl.className = "status error";
          authStatusEl.textContent = `El usuario ${user.email} no es admin (role actual: ${data.role || "sin definir"}).`;
          btnImport.disabled = true;
          btnImportToBank.disabled = true;
          return;
        }

        isAdmin = true;
        authStatusEl.className = "status ok";
        authStatusEl.textContent = `Autenticado como ADMIN: ${user.email}.`;
        btnImport.disabled = false;
        btnImportToBank.disabled = false;
      } catch (err) {
        console.error(err);
        isAdmin = false;
        authStatusEl.className = "status error";
        authStatusEl.textContent = "Error verificando role de admin en 'users'. Revisa la consola.";
        btnImport.disabled = true;
        btnImportToBank.disabled = true;
      }
    });

    // ==========================
    // 1) IMPORTAR EXAMEN (igual que tu versión)
    // ==========================
    async function importExamFromJson() {
      if (!isAdmin) return alert("Solo un admin puede importar exámenes.");

      let parsed;
      try {
        parsed = parseJsonOrThrow();
      } catch (err) {
        alert(err.message);
        log(err.message);
        return;
      }

      const sectionName = parsed.sectionName || null;
      const sectionIdFromJson = parsed.sectionId || null;
      const examName = parsed.examName || null;
      const cases = Array.isArray(parsed.cases) ? parsed.cases : [];
      const examIdFromJson = parsed.examId || null;

      if (!examName || !cases.length) {
        alert("El JSON debe incluir 'examName' y un arreglo 'cases' con al menos 1 caso clínico.");
        log("JSON incompleto: falta examName o cases.");
        return;
      }

      btnImport.disabled = true;
      log("Iniciando importación de EXAMEN...");

      try {
        // 1) RESOLVER SECTION
        let finalSectionId = sectionIdFromJson;

        if (!finalSectionId) {
          if (!sectionName) throw new Error("Falta 'sectionId' o 'sectionName' en el JSON.");

          const qSec = query(collection(db, "sections"), where("name", "==", sectionName));
          const snapSec = await getDocs(qSec);

          if (!snapSec.empty) {
            finalSectionId = snapSec.docs[0].id;
            log(`Sección existente reutilizada: "${sectionName}" (id: ${finalSectionId})`);
          } else {
            const secRef = await addDoc(collection(db, "sections"), {
              name: sectionName,
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp(),
            });
            finalSectionId = secRef.id;
            log(`Sección creada: "${sectionName}" (id: ${finalSectionId})`);
          }
        } else {
          log(`Se utilizará la sección existente con id: ${finalSectionId}`);
        }

        // 2) RESOLVER / CREAR EXAMEN
        let examRef;
        let examId;

        if (examIdFromJson) {
          examRef = doc(db, "exams", examIdFromJson);
          const exSnap = await getDoc(examRef);
          if (!exSnap.exists()) throw new Error(`El examId ${examIdFromJson} no existe en 'exams'.`);

          const exData = exSnap.data() || {};
          const updates = { updatedAt: serverTimestamp() };
          if (!exData.createdAt) updates.createdAt = serverTimestamp();
          await updateDoc(examRef, updates);

          examId = examIdFromJson;
          log(`Se usará examen EXISTENTE por examId: ${examIdFromJson}`);
        } else {
          let existingExamId = null;

          if (finalSectionId && examName) {
            const qEx = query(
              collection(db, "exams"),
              where("sectionId", "==", finalSectionId),
              where("name", "==", examName)
            );
            const snapEx = await getDocs(qEx);
            if (!snapEx.empty) existingExamId = snapEx.docs[0].id;
          }

          if (existingExamId) {
            examRef = doc(db, "exams", existingExamId);
            const exSnap = await getDoc(examRef);
            const exData = exSnap.data() || {};
            const updates = { updatedAt: serverTimestamp() };
            if (!exData.createdAt) updates.createdAt = serverTimestamp();
            await updateDoc(examRef, updates);

            examId = existingExamId;
            log(`Se usará examen EXISTENTE "${examName}" (id: ${existingExamId}) para añadir preguntas.`);
          } else {
            const newExamRef = await addDoc(collection(db, "exams"), {
              name: examName,
              sectionId: finalSectionId,
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp(),
            });
            examRef = newExamRef;
            examId = newExamRef.id;
            log(`Examen creado: "${examName}" (id: ${examId})`);
          }
        }

        // 3) CREAR QUESTIONS (cada caso = 1 doc)
        let totalQuestions = 0;

        for (const [index, c] of cases.entries()) {
          const caseText = c.caseText || "";
          const specialty = c.specialty || null;
          const qArr = Array.isArray(c.questions) ? c.questions : [];

          if (!caseText.trim()) {
            log(`Caso clínico ${index + 1} sin caseText, se omite.`);
            continue;
          }
          if (!qArr.length) {
            log(`Caso clínico ${index + 1} sin preguntas, se omite.`);
            continue;
          }

          const questionsForDoc = qArr.map((q) => ({
            questionText: q.questionText || "",
            optionA: q.optionA || "",
            optionB: q.optionB || "",
            optionC: q.optionC || "",
            optionD: q.optionD || "",
            correctOption: q.correctOption || "A",
            justification: q.justification || "",
            difficulty: q.difficulty || "baja",
            subtype: q.subtype || "salud_publica",
          }));

          const qRef = await addDoc(collection(db, "questions"), {
            examId: examId,
            caseText,
            specialty,
            questions: questionsForDoc,
            createdAt: serverTimestamp(),
          });

          totalQuestions += questionsForDoc.length;
          log(`Caso ${index + 1} creado en 'questions' (id: ${qRef.id}, preguntas: ${questionsForDoc.length})`);
        }

        log(`IMPORTACIÓN EXAMEN COMPLETA. Preguntas creadas: ${totalQuestions}.`);
        alert(
          `Examen importado correctamente.\n` +
          `SectionID: ${finalSectionId}\n` +
          `ExamID: ${examId}\n` +
          `Nuevas preguntas: ${totalQuestions}`
        );
      } catch (err) {
        console.error(err);
        log("ERROR importando EXAMEN: " + err.message);
        alert("Ocurrió un error al importar el examen. Revisa consola y log.");
      } finally {
        btnImport.disabled = false;
      }
    }

    // ==========================
    // 2) IMPORTAR LOTE A BANCO (caseBank)
    // - Tema obligatorio
    // - Dedup por hash (topicLower + caseTextLower)
    // ==========================
    async function importLotToCaseBank() {
      if (!isAdmin) return alert("Solo un admin puede importar al banco.");

      const topic = (topicInput.value || "").trim();
      if (!topic) {
        alert("Escribe el TEMA del lote (obligatorio) para importar al banco.");
        return;
      }

      let parsed;
      try {
        parsed = parseJsonOrThrow();
      } catch (err) {
        alert(err.message);
        log(err.message);
        return;
      }

      const cases = Array.isArray(parsed.cases) ? parsed.cases : [];
      if (!cases.length) {
        alert("El JSON debe incluir 'cases' con al menos 1 caso clínico.");
        log("JSON incompleto: falta cases.");
        return;
      }

      btnImportToBank.disabled = true;
      log("Iniciando importación a BANCO (caseBank)...");

      try {
        const topicLower = normalizeLower(topic);
        const topicTokens = tokenize(topic, 20);

        let created = 0;
        let updated = 0;
        let skipped = 0;

        for (const [index, c] of cases.entries()) {
          const caseText = c.caseText || "";
          const specialty = c.specialty || "";
          const qArr = Array.isArray(c.questions) ? c.questions : [];

          if (!caseText.trim() || !qArr.length) {
            skipped++;
            log(`Banco: caso ${index + 1} omitido (sin caseText o sin questions).`);
            continue;
          }

          const caseTextLower = normalizeLower(caseText);
          const hash = fnv1a32(topicLower + "||" + caseTextLower);

          // normalizar preguntas al formato esperado
          const questions = qArr.map((q) => ({
            questionText: q.questionText || "",
            optionA: q.optionA || "",
            optionB: q.optionB || "",
            optionC: q.optionC || "",
            optionD: q.optionD || "",
            correctOption: q.correctOption || "A",
            justification: q.justification || "",
            difficulty: q.difficulty || "media",
            subtype: q.subtype || "salud_publica",
          }));

          // Dedupe por docId = hash
          const caseRef = doc(db, "caseBank", hash);
          const existing = await getDoc(caseRef);

          if (existing.exists()) {
            // ya existe: no duplicar, solo actualizar campos útiles
            await setDoc(caseRef, {
              topic,
              topicLower,
              topicTokens,
              caseText,
              caseTextLower,
              specialty,
              questions,
              updatedAt: serverTimestamp(),
            }, { merge: true });

            updated++;
            log(`Banco: caso ${index + 1} YA EXISTÍA (hash ${hash}). Actualizado.`);
          } else {
            await setDoc(caseRef, {
              topic,
              topicLower,
              topicTokens,
              caseText,
              caseTextLower,
              specialty,
              questions,
              usageCount: 0,
              createdAt: serverTimestamp(),
              updatedAt: serverTimestamp(),
            });

            created++;
            log(`Banco: caso ${index + 1} creado (hash ${hash}).`);
          }
        }

        log(`IMPORTACIÓN BANCO COMPLETA. Creados: ${created}, Actualizados: ${updated}, Omitidos: ${skipped}.`);
        alert(`Banco actualizado.\nCreados: ${created}\nActualizados: ${updated}\nOmitidos: ${skipped}`);
      } catch (err) {
        console.error(err);
        log("ERROR importando a BANCO: " + err.message);
        alert("Error importando al banco (caseBank). Revisa consola y log.");
      } finally {
        btnImportToBank.disabled = false;
      }
    }

    btnImport.addEventListener("click", importExamFromJson);
    btnImportToBank.addEventListener("click", importLotToCaseBank);

    // ==========================
    // EJEMPLO
    // ==========================
    btnFillExample.addEventListener("click", () => {
      const example = {
        sectionName: "Vuelta 1",
        examName: "Examen 76 - Vuelta 1",
        cases: [
          {
            caseText:
              "Paciente masculino de 68 años, antecedente de EPOC GOLD D, exfumador de 40 paquetes-año, con oxígeno domiciliario. Acude a urgencias por disnea progresiva de 3 días, aumento de volumen y purulencia del esputo, fiebre de 38.3 °C y uso de músculos accesorios. TA 130/80 mmHg, FC 112 lpm, FR 30 rpm, SatO2 84% al aire ambiente. A la exploración estertores y sibilancias difusas, uso de músculos accesorios, tiraje intercostal.",
            specialty: "medicina_interna",
            questions: [
              {
                questionText:
                  "¿Cuál es el siguiente paso MÁS adecuado en el manejo inicial de este paciente en el servicio de urgencias?",
                optionA: "Iniciar antibiótico oral y dar de alta con vigilancia estrecha",
                optionB: "Administrar broncodilatadores inhalados de acción corta y reevaluar en 48 horas",
                optionC:
                  "Iniciar oxígeno suplementario, broncodilatadores inhalados y valorar ventilación no invasiva",
                optionD: "Solicitar espirometría inmediata para ajustar el tratamiento de base",
                correctOption: "C",
                justification:
                  "Se trata de una exacerbación grave de EPOC con datos de insuficiencia respiratoria aguda. El manejo inicial incluye oxígeno suplementario controlado, broncodilatadores de acción corta y valoración temprana de ventilación no invasiva.",
                difficulty: "media",
                subtype: "urgencias",
              },
              {
                questionText:
                  "Tras el manejo inicial, el paciente persiste con trabajo respiratorio importante y acidosis respiratoria en gasometría. ¿Qué parámetro gasométrico es el MÁS útil para decidir ventilación no invasiva?",
                optionA: "Frecuencia cardíaca mayor de 100 lpm",
                optionB: "PaO2 mayor de 60 mmHg con oxígeno suplementario",
                optionC: "PaCO2 elevada con pH menor de 7.35",
                optionD: "Bicarbonato sérico disminuido con anion gap elevado",
                correctOption: "C",
                justification:
                  "La indicación clásica de ventilación no invasiva en exacerbación de EPOC es la presencia de acidosis respiratoria (PaCO2 elevada con pH < 7.35), en el contexto de insuficiencia respiratoria aguda.",
                difficulty: "alta",
                subtype: "urgencias",
              },
            ],
          },
        ],
      };

      jsonInput.value = JSON.stringify(example, null, 2);
      log("Ejemplo de JSON (Examen 76) cargado.");
    });
  </script>
</body>
</html>

