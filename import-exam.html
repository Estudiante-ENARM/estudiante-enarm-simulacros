<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Importar Casos al Banco (questions)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="logo.png" />

  <style>
    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 920px;
      margin: 32px auto;
      background: #020617;
      border-radius: 12px;
      padding: 20px 22px;
      border: 1px solid rgba(148,163,184,.4);
    }
    h1 { font-size: 20px; margin-bottom: 6px; }
    .subtitle { font-size: 13px; color: #9ca3af; margin-bottom: 16px; line-height: 1.45; }
    .status { font-size: 13px; margin-bottom: 16px; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(148,163,184,.25); }
    .status.error { background: rgba(220,38,38,.10); color:#fecaca; border-color: rgba(220,38,38,.35); }
    .status.ok { background: rgba(22,163,74,.10); color:#bbf7d0; border-color: rgba(22,163,74,.35); }
    label { font-size: 13px; display:block; margin-bottom:6px; color:#cbd5e1; }
    input, textarea {
      width:100%;
      border-radius:10px;
      border:1px solid rgba(148,163,184,.5);
      padding:10px 12px;
      font-size:13px;
      background:#020617;
      color:#e5e7eb;
      outline: none;
    }
    textarea { min-height:320px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .btn-row { margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; }
    button {
      padding:10px 16px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      font-size:14px;
      font-weight:600;
    }
    .btn-primary { background:#2563eb; color:white; }
    .btn-secondary { background:#334155; color:white; border: 1px solid rgba(148,163,184,.35); }
    button:disabled { opacity: .6; cursor: not-allowed; }
    pre {
      margin-top:16px;
      background:#020617;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(148,163,184,.35);
      font-size:12px;
      max-height:260px;
      overflow:auto;
      white-space: pre-wrap;
      line-height: 1.45;
    }
    .row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (min-width: 760px) {
      .row {
        grid-template-columns: 1fr 1fr;
      }
    }
    .hint {
      font-size: 12px;
      color: #94a3b8;
      margin-top: 6px;
      line-height: 1.4;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Importar casos al banco (questions)</h1>
    <p class="subtitle">
      Esta página inserta casos clínicos y sus preguntas directamente en la colección <code>questions</code> como banco general.
      No se asocia a ningún examen.
    </p>

    <div id="auth-status" class="status error">Verificando autenticación…</div>

    <div class="row">
      <div>
        <label for="topicInput">Tema del lote (topic por defecto)</label>
        <input id="topicInput" type="text" placeholder="Escribe el topic por defecto (opcional)" />
        <div class="hint">
          Si un caso no trae <code>topic</code> en su JSON, se usará este valor.
        </div>
      </div>

      <div>
        <label for="specialtyDefaultInput">Especialidad por defecto (opcional)</label>
        <input id="specialtyDefaultInput" type="text" placeholder="Escribe specialty por defecto (opcional)" />
        <div class="hint">
          Si un caso no trae <code>specialty</code>, se usará este valor.
        </div>
      </div>
    </div>

    <label for="jsonInput" style="margin-top:12px;">JSON</label>
    <textarea id="jsonInput" placeholder="Pega aquí el JSON…"></textarea>
    <div class="hint">
      Formatos aceptados:
      <br>- <code>{"cases":[ ... ]}</code>
      <br>- <code>[ ... ]</code>
    </div>

    <div class="btn-row">
      <button id="btnImport" class="btn-primary" disabled>Importar al banco</button>
      <button id="btnClear" class="btn-secondary" type="button">Limpiar</button>
    </div>

    <pre id="log"></pre>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      doc,
      getDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDAGsmp2qwZ2VBBKIDpUF0NUElcCLsGanQ",
      authDomain: "simulacros-plataforma-enarm.firebaseapp.com",
      projectId: "simulacros-plataforma-enarm",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const authStatusEl = document.getElementById("auth-status");
    const topicInput = document.getElementById("topicInput");
    const specialtyDefaultInput = document.getElementById("specialtyDefaultInput");
    const jsonInput = document.getElementById("jsonInput");
    const btnImport = document.getElementById("btnImport");
    const btnClear = document.getElementById("btnClear");
    const logEl = document.getElementById("log");

    function log(msg) {
      const time = new Date().toLocaleTimeString("es-MX");
      logEl.textContent += `[${time}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function normalizeText(str) {
      return (str || "").toString().trim();
    }

    function normalizeCase(raw, fallbackTopic, fallbackSpecialty) {
      const caseText = normalizeText(raw?.caseText || raw?.case || "");
      const specialty = normalizeText(raw?.specialty || fallbackSpecialty || "");
      const topic = normalizeText(raw?.topic || fallbackTopic || "");
      const questions = Array.isArray(raw?.questions) ? raw.questions : [];

      const normalizedQuestions = questions.map((q) => ({
        questionText: normalizeText(q?.questionText || q?.question || ""),
        optionA: normalizeText(q?.optionA || q?.a || ""),
        optionB: normalizeText(q?.optionB || q?.b || ""),
        optionC: normalizeText(q?.optionC || q?.c || ""),
        optionD: normalizeText(q?.optionD || q?.d || ""),
        correctOption: normalizeText(q?.correctOption || q?.correct || q?.answer || ""),
        justification: normalizeText(q?.justification || q?.explanation || ""),
        subtype: normalizeText(q?.subtype || "salud_publica"),
        difficulty: normalizeText(q?.difficulty || "media"),
      }));

      return { caseText, specialty, topic, questions: normalizedQuestions };
    }

    function extractCases(parsed) {
      if (Array.isArray(parsed)) return parsed;
      if (parsed && Array.isArray(parsed.cases)) return parsed.cases;
      return [];
    }

    function validateCase(c) {
      if (!c.caseText) return "caseText vacío";
      if (!Array.isArray(c.questions) || !c.questions.length) return "sin preguntas";

      for (const q of c.questions) {
        if (!q.questionText) return "pregunta sin questionText";
        if (!q.optionA || !q.optionB || !q.optionC || !q.optionD) return "pregunta con opciones incompletas";
        if (!q.correctOption) return "pregunta sin correctOption";
        if (!q.justification) return "pregunta sin justification";
      }
      return null;
    }

    function setLoading(isLoading) {
      btnImport.disabled = isLoading;
      btnClear.disabled = isLoading;
      btnImport.textContent = isLoading ? "Importando…" : "Importar al banco";
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        authStatusEl.className = "status error";
        authStatusEl.textContent = "No hay sesión iniciada. Inicia sesión como admin.";
        return;
      }

      try {
        const snap = await getDoc(doc(db, "users", user.email));
        if (!snap.exists() || snap.data()?.role !== "admin") {
          authStatusEl.className = "status error";
          authStatusEl.textContent = "No autorizado. Este usuario no es admin.";
          return;
        }

        authStatusEl.className = "status ok";
        authStatusEl.textContent = `Admin autenticado: ${user.email}`;
        btnImport.disabled = false;
      } catch (e) {
        console.error(e);
        authStatusEl.className = "status error";
        authStatusEl.textContent = "Error verificando permisos. Revisa consola.";
      }
    });

    btnClear.addEventListener("click", () => {
      jsonInput.value = "";
      logEl.textContent = "";
    });

    btnImport.addEventListener("click", async () => {
      let parsed;
      try {
        parsed = JSON.parse(jsonInput.value);
      } catch {
        alert("JSON inválido");
        return;
      }

      const rawCases = extractCases(parsed);
      if (!rawCases.length) {
        alert("No se encontraron casos en el JSON.");
        return;
      }

      const fallbackTopic = normalizeText(topicInput.value);
      const fallbackSpecialty = normalizeText(specialtyDefaultInput.value);

      const normalizedCases = rawCases.map((c) => normalizeCase(c, fallbackTopic, fallbackSpecialty));

      // Validación previa (fail-fast)
      for (let i = 0; i < normalizedCases.length; i++) {
        const err = validateCase(normalizedCases[i]);
        if (err) {
          alert(`Error en caso #${i + 1}: ${err}`);
          return;
        }
      }

      if (!confirm(`Se importarán ${normalizedCases.length} casos al banco (questions). ¿Continuar?`)) {
        return;
      }

      setLoading(true);
      log(`Iniciando importación. Casos: ${normalizedCases.length}`);

      try {
        let okCount = 0;

        for (let i = 0; i < normalizedCases.length; i++) {
          const c = normalizedCases[i];

          await addDoc(collection(db, "questions"), {
            caseText: c.caseText,
            specialty: c.specialty,
            topic: c.topic,
            questions: c.questions,
            createdAt: serverTimestamp(),
          });

          okCount++;
          if (okCount % 10 === 0) {
            log(`Importados: ${okCount}/${normalizedCases.length}`);
          }
        }

        log(`Importación completada. Importados: ${okCount}`);
        alert("Importado correctamente.");
      } catch (e) {
        console.error(e);
        log("Error durante la importación. Revisa consola.");
        alert("Hubo un error al importar. Revisa la consola.");
      } finally {
        setLoading(false);
      }
    });
  </script>
</body>
</html>
