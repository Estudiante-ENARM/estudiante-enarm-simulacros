<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Importar examen ENARM</title>
</head>
<body>
  <h1>Importar examen por JSON</h1>

  <p>
    Esta página crea un examen en las colecciones:<br>
    <strong>sections</strong> → <strong>exams</strong> → <strong>questions</strong><br>
    sin modificar nada de tu plataforma actual.
  </p>

  <div style="margin:16px 0;">
    <label>
      <strong>JSON del examen:</strong><br>
      <textarea id="json-input" rows="18" cols="90"
        placeholder='Pega aquí el JSON del examen'></textarea>
    </label>
  </div>

  <button id="btn-import">Importar examen</button>

  <pre id="log" style="margin-top:16px;font-size:13px;background:#111;color:#eee;padding:10px;max-width:900px;"></pre>

  <script type="module">
    // ===========================
    // 1) IMPORTS FIREBASE CDN
    // ===========================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      doc,
      getDoc,
      getDocs,
      addDoc,
      setDoc,
      query,
      where,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ===========================
    // 2) CONFIGURACIÓN FIREBASE
    // ===========================
    const firebaseConfig = {
      apiKey: "AIzaSyDAGsmp2qwZ2VBBKIDpUF0NUElcCLsGanQ",
      authDomain: "simulacros-plataforma-enarm.firebaseapp.com",
      projectId: "simulacros-plataforma-enarm",
      storageBucket: "simulacros-plataforma-enarm.firebasestorage.app",
      messagingSenderId: "1012829203040",
      appId: "1:1012829203040:web:71de568ff8606a1c8d7105",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const jsonInput = document.getElementById("json-input");
    const btnImport = document.getElementById("btn-import");
    const logEl = document.getElementById("log");

    function log(msg) {
      console.log(msg);
      logEl.textContent += msg + "\\n";
    }

    // ===========================
    // 3) UTILIDADES
    // ===========================
    function difficultyWeight(difficulty) {
      if (difficulty === "alta") return 3;
      if (difficulty === "media") return 2;
      return 1; // baja o sin definir
    }

    async function getOrCreateSection(sectionName) {
      const qSec = query(
        collection(db, "sections"),
        where("name", "==", sectionName)
      );
      const snap = await getDocs(qSec);
      if (!snap.empty) {
        const docFound = snap.docs[0];
        log("Sección encontrada: " + sectionName + " (" + docFound.id + ")");
        return docFound.id;
      }

      const docRef = await addDoc(collection(db, "sections"), {
        name: sectionName,
        createdAt: serverTimestamp(),
      });
      log("Sección creada: " + sectionName + " (" + docRef.id + ")");
      return docRef.id;
    }

    async function createExam(sectionId, examName) {
      const docRef = await addDoc(collection(db, "exams"), {
        name: examName,
        sectionId,
        attemptsCount: 0,
        createdAt: serverTimestamp(),
      });
      log("Examen creado: " + examName + " (" + docRef.id + ")");
      return docRef.id;
    }

    async function createCaseQuestions(examId, casesArray) {
      let countCases = 0;
      let countQuestions = 0;

      for (const caseItem of casesArray) {
        if (!caseItem) continue;

        const caseText = (caseItem.caseText || "").trim();
        const specialty = caseItem.specialty || ""; // ej. "medicina_interna"
        const questionsArr = Array.isArray(caseItem.questions)
          ? caseItem.questions
          : [];

        if (!caseText || questionsArr.length === 0) {
          log("Saltando caso SIN texto o SIN preguntas.");
          continue;
        }

        // Transformar TODAS las preguntas de este caso en un solo array
        const questionsForDoc = questionsArr.map((q) => {
          const difficulty = q.difficulty || "media";
          const subtype = q.subtype || "salud_publica";

          countQuestions++;

          return {
            questionText: q.questionText || "",
            optionA: q.optionA || "",
            optionB: q.optionB || "",
            optionC: q.optionC || "",
            optionD: q.optionD || "",
            correctOption: q.correctOption || "",
            justification: q.justification || "",
            difficulty,
            difficultyWeight: difficultyWeight(difficulty),
            subtype,
          };
        });

        await addDoc(collection(db, "questions"), {
          examId,
          caseText,
          specialty,
          questions: questionsForDoc,
          createdAt: serverTimestamp(),
        });

        countCases++;
      }

      log("Casos clínicos creados: " + countCases);
      log("Preguntas totales cargadas: " + countQuestions);
    }

    // ===========================
    // 4) IMPORTAR DESDE JSON
    // ===========================
    /*
      ESTRUCTURA ESPERADA DEL JSON:

      {
        "sectionName": "Simulacro Vuelta 1",
        "examName": "Examen 76",
        "cases": [
          {
            "caseText": "Paciente masculino de 65 años...",
            "specialty": "medicina_interna", // (opcional, pero recomendado)
            "questions": [
              {
                "questionText": "¿Cuál es el diagnóstico más probable?",
                "optionA": "...",
                "optionB": "...",
                "optionC": "...",
                "optionD": "...",
                "correctOption": "B",
                "justification": "Según la GPC...",
                "difficulty": "media",          // "baja" | "media" | "alta"
                "subtype": "medicina_familiar"  // "salud_publica" | "medicina_familiar" | "urgencias"
              },
              {
                "questionText": "¿Qué estudio pedirías como siguiente paso?",
                "optionA": "...",
                "optionB": "...",
                "optionC": "...",
                "optionD": "...",
                "correctOption": "D",
                "justification": "Porque...",
                "difficulty": "alta",
                "subtype": "urgencias"
              }
            ]
          },
          ...
        ]
      }
    */

    btnImport.addEventListener("click", async () => {
      logEl.textContent = "";
      try {
        const raw = jsonInput.value.trim();
        if (!raw) {
          alert("Pega primero el JSON del examen.");
          return;
        }

        let data;
        try {
          data = JSON.parse(raw);
        } catch (err) {
          log("ERROR: JSON inválido.");
          console.error(err);
          alert("JSON inválido. Revisa comas, llaves, etc.");
          return;
        }

        const sectionName = (data.sectionName || "").trim();
        const examName = (data.examName || "").trim();
        const casesArray = Array.isArray(data.cases) ? data.cases : [];

        if (!sectionName || !examName || casesArray.length === 0) {
          alert("Faltan datos obligatorios: sectionName, examName o cases.");
          log("Faltan datos obligatorios.");
          return;
        }

        log("=== INICIANDO IMPORTACIÓN ===");
        log("Sección: " + sectionName);
        log("Examen: " + examName);
        log("Casos a importar: " + casesArray.length);

        const sectionId = await getOrCreateSection(sectionName);
        const examId = await createExam(sectionId, examName);
        await createCaseQuestions(examId, casesArray);

        log("=== IMPORTACIÓN COMPLETADA ===");
        alert("Examen importado correctamente. Revisa tu panel de admin.");
      } catch (err) {
        console.error(err);
        log("ERROR GENERAL: " + (err.message || err));
        alert("Ocurrió un error en la importación. Revisa la consola.");
      }
    });
  </script>
</body>
</html>
