import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  doc,
  getDoc,
  addDoc,
  updateDoc,
  deleteDoc,
  getDocs,
  query,
  where,
  orderBy,
  limit,
  startAfter,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/**
 * ==========================
 * CONFIG FIREBASE
 * ==========================
 */
const firebaseConfig = {
  apiKey: "AIzaSyDAGsmp2qwZ2VBBKIDpUF0NUElcCLsGanQ",
  authDomain: "simulacros-plataforma-enarm.firebaseapp.com",
  projectId: "simulacros-plataforma-enarm",
  storageBucket: "simulacros-plataforma-enarm.firebasestorage.app",
  messagingSenderId: "1012829203040",
  appId: "1:1012829203040:web:71de568ff8606a1c8d7105",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/**
 * ==========================
 * HELPERS UI
 * ==========================
 */
const $ = (id) => document.getElementById(id);
const show = (el) => el.classList.remove("hidden");
const hide = (el) => el.classList.add("hidden");

function escapeHtml(str = "") {
  return String(str)
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function toast(msg) {
  // Minimalista: usa alert para no romper tu CSS/JS existente.
  alert(msg);
}

/**
 * ==========================
 * AUTH / ROLE CHECK
 * ==========================
 */
let currentUser = null;

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "index.html";
    return;
  }

  currentUser = user;
  $("admin-user-email").textContent = user.email || "";

  const uref = doc(db, "users", user.email);
  const usnap = await getDoc(uref);

  if (!usnap.exists()) {
    toast("Tu usuario no existe en la colección 'users'.");
    await signOut(auth);
    window.location.href = "index.html";
    return;
  }

  const udata = usnap.data() || {};
  if (udata.role !== "admin") {
    toast("No tienes permisos de administrador.");
    await signOut(auth);
    window.location.href = "index.html";
    return;
  }

  // ✅ Admin ok: inicializa todo
  initUI();
  await loadSectionsSidebar();
  await loadMiniBank();
  await loadBankFirstPage(); // banco preguntas
});

$("admin-btn-logout").addEventListener("click", async () => {
  await signOut(auth);
  window.location.href = "index.html";
});

/**
 * ==========================
 * SIDEBAR TOGGLE
 * ==========================
 */
$("admin-btn-toggle-sidebar").addEventListener("click", () => {
  const sidebar = $("admin-sidebar");
  sidebar.classList.toggle("open");
});

/**
 * ==========================
 * PANEL NAV
 * ==========================
 */
const panels = {
  exams: $("admin-panel-exams"),
  bank: $("admin-panel-bank"),
  mini: $("admin-panel-mini"),
  users: $("admin-panel-users"),
  analytics: $("admin-panel-analytics"),
  landing: $("admin-panel-landing"),
};

function setActiveNav(btnId) {
  const ids = [
    "admin-btn-nav-exams",
    "admin-btn-nav-bank",
    "admin-btn-nav-mini",
    "admin-btn-nav-users",
    "admin-btn-nav-analytics",
    "admin-btn-nav-landing",
  ];
  ids.forEach((id) => {
    const b = $(id);
    if (!b) return;
    b.classList.toggle("sidebar-btn--active", id === btnId);
  });
}

function openPanel(name) {
  Object.values(panels).forEach((p) => hide(p));
  show(panels[name]);
}

function initUI() {
  $("admin-btn-nav-exams").addEventListener("click", () => {
    setActiveNav("admin-btn-nav-exams");
    openPanel("exams");
  });

  // ✅ NUEVO
  $("admin-btn-nav-bank").addEventListener("click", async () => {
    setActiveNav("admin-btn-nav-bank");
    openPanel("bank");
    // si no hay data cargada, carga primera página
    if (!bankState.loadedOnce) await loadBankFirstPage();
  });

  $("admin-btn-nav-mini").addEventListener("click", async () => {
    setActiveNav("admin-btn-nav-mini");
    openPanel("mini");
    await loadMiniBank();
  });

  $("admin-btn-nav-users").addEventListener("click", () => {
    setActiveNav("admin-btn-nav-users");
    openPanel("users");
  });

  $("admin-btn-nav-analytics").addEventListener("click", () => {
    setActiveNav("admin-btn-nav-analytics");
    openPanel("analytics");
  });

  $("admin-btn-nav-landing").addEventListener("click", () => {
    setActiveNav("admin-btn-nav-landing");
    openPanel("landing");
  });

  // Banco: filtros
  $("admin-bank-btn-apply").addEventListener("click", loadBankFirstPage);
  $("admin-bank-btn-clear").addEventListener("click", () => {
    $("admin-bank-search").value = "";
    $("admin-bank-topic").value = "";
    $("admin-bank-specialty").value = "";
    $("admin-bank-examid").value = "";
    loadBankFirstPage();
  });
  $("admin-bank-btn-refresh").addEventListener("click", loadBankFirstPage);
  $("admin-bank-btn-load-more").addEventListener("click", loadBankNextPage);

  // Banco -> mini
  $("admin-bank-btn-add-to-mini").addEventListener("click", addSelectedBankCasesToMini);
}

/**
 * ==========================
 * SECTIONS / EXAMS (mínimo necesario sin tocar tu estudiante)
 * Nota: aquí solo dejo la base para no romper tu UI.
 * Si tu admin.js anterior tenía más lógica específica, se integra sobre este mismo patrón.
 * ==========================
 */
let currentSectionId = null;

async function loadSectionsSidebar() {
  const list = $("admin-sections-list");
  list.innerHTML = "";

  const snap = await getDocs(query(collection(db, "sections"), orderBy("createdAt", "desc")));
  snap.forEach((d) => {
    const data = d.data() || {};
    const li = document.createElement("li");
    li.className = "sidebar-section-item";
    li.textContent = data.name || d.id;
    li.style.cursor = "pointer";
    li.addEventListener("click", async () => {
      currentSectionId = d.id;
      $("admin-current-section-title").textContent = data.name || "Sección";
      await loadExamsForSection(d.id);
      setActiveNav("admin-btn-nav-exams");
      openPanel("exams");
    });
    list.appendChild(li);
  });
}

async function loadExamsForSection(sectionId) {
  const container = $("admin-exams-list");
  container.innerHTML = "";

  const qEx = query(collection(db, "exams"), where("sectionId", "==", sectionId));
  const snap = await getDocs(qEx);

  if (snap.empty) {
    container.innerHTML = `<div class="card"><p class="panel-subtitle">No hay exámenes en esta sección.</p></div>`;
    return;
  }

  snap.forEach((d) => {
    const ex = d.data() || {};
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <h3 style="margin:0 0 6px 0;">${escapeHtml(ex.name || "Examen")}</h3>
      <p class="panel-subtitle" style="margin:0;">ExamID: <code>${d.id}</code></p>
    `;
    container.appendChild(card);
  });
}

/**
 * ==========================
 * MINI BANK (miniQuestions)
 * ==========================
 */
async function loadMiniBank() {
  const container = $("admin-mini-cases");
  if (!container) return;
  container.innerHTML = "";

  const snap = await getDocs(query(collection(db, "miniQuestions"), orderBy("createdAt", "desc"), limit(100)));
  if (snap.empty) {
    container.innerHTML = `<div class="card"><p class="panel-subtitle">Aún no hay casos en miniQuestions.</p></div>`;
    return;
  }

  snap.forEach((d) => {
    const data = d.data() || {};
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <h3 style="margin:0 0 6px 0;">${escapeHtml(data.topic || "Sin tema")} <span style="opacity:.65;font-size:12px;">(${escapeHtml(data.specialty || "")})</span></h3>
      <p class="panel-subtitle" style="margin:0 0 8px 0;">MiniID: <code>${d.id}</code>${data.sourceQuestionId ? ` · Origen: <code>${escapeHtml(data.sourceQuestionId)}</code>` : ""}</p>
      <details>
        <summary style="cursor:pointer;">Ver caso</summary>
        <pre style="white-space:pre-wrap;">${escapeHtml(data.caseText || "")}</pre>
      </details>
    `;
    container.appendChild(card);
  });
}

/**
 * ==========================
 * ✅ BANCO DE PREGUNTAS (questions)
 * - Paginación (Spark-friendly)
 * - Filtros
 * - Edición y guardado
 * - Selección múltiple -> copiar a miniQuestions
 * ==========================
 */
const bankState = {
  pageSize: 20,
  lastDoc: null,
  hasMore: true,
  loadedOnce: false,
  selected: new Map(), // questionId -> data
};

function getBankFilters() {
  return {
    searchText: ($("admin-bank-search")?.value || "").trim(),
    topic: ($("admin-bank-topic")?.value || "").trim(),
    specialty: ($("admin-bank-specialty")?.value || "").trim(),
    examId: ($("admin-bank-examid")?.value || "").trim(),
  };
}

function buildBankQuery({ forNextPage = false } = {}) {
  const { topic, specialty, examId } = getBankFilters();

  // Base: ordena por createdAt desc (si no existe, Firestore puede fallar; por eso en import-exam.html ya lo agregamos)
  let qRef = collection(db, "questions");
  let clauses = [];

  if (examId) clauses.push(where("examId", "==", examId));
  if (specialty) clauses.push(where("specialty", "==", specialty));
  if (topic) clauses.push(where("topic", "==", topic));

  // Orden y límites
  const parts = [
    ...clauses,
    orderBy("createdAt", "desc"),
    limit(bankState.pageSize),
  ];

  // paginación
  if (forNextPage && bankState.lastDoc) {
    parts.splice(parts.length - 1, 0, startAfter(bankState.lastDoc));
  }

  return query(qRef, ...parts);
}

async function loadBankFirstPage() {
  bankState.lastDoc = null;
  bankState.hasMore = true;
  bankState.loadedOnce = true;
  bankState.selected.clear();
  updateBankSelectionUI();

  $("admin-bank-list").innerHTML = "";
  await loadBankPage({ next: false });
}

async function loadBankNextPage() {
  if (!bankState.hasMore) return;
  await loadBankPage({ next: true });
}

async function loadBankPage({ next }) {
  const container = $("admin-bank-list");
  const filters = getBankFilters();
  const qBank = buildBankQuery({ forNextPage: next });

  let snap;
  try {
    snap = await getDocs(qBank);
  } catch (err) {
    console.error(err);
    toast(
      "Firestore rechazó esta consulta. Esto suele pasar cuando necesitas un ÍNDICE COMPUESTO.\n" +
      "Abre la consola del navegador: ahí Firestore te muestra el link directo para crear el índice."
    );
    return;
  }

  if (snap.empty) {
    if (!next) {
      container.innerHTML = `<div class="card"><p class="panel-subtitle">No hay resultados con estos filtros.</p></div>`;
    }
    bankState.hasMore = false;
    return;
  }

  // Actualiza lastDoc
  bankState.lastDoc = snap.docs[snap.docs.length - 1];
  bankState.hasMore = snap.size === bankState.pageSize;

  // Render
  snap.forEach((d) => {
    const data = d.data() || {};

    // Filtro de texto (client-side, para no requerir “full text search”)
    if (filters.searchText) {
      const t = filters.searchText.toLowerCase();
      const hay = (data.caseText || "").toLowerCase();
      if (!hay.includes(t)) return;
    }

    container.appendChild(renderBankCard(d.id, data));
  });
}

function renderBankCard(id, data) {
  const card = document.createElement("div");
  card.className = "card";
  card.dataset.qid = id;

  const checked = bankState.selected.has(id) ? "checked" : "";

  const topic = data.topic || "";
  const specialty = data.specialty || "";
  const examId = data.examId || "";
  const caseText = data.caseText || "";
  const questionsArr = Array.isArray(data.questions) ? data.questions : [];

  card.innerHTML = `
    <div style="display:flex;gap:10px;align-items:flex-start;justify-content:space-between;">
      <div style="display:flex;gap:10px;align-items:flex-start;">
        <input type="checkbox" class="bank-select" ${checked} />
        <div>
          <h3 style="margin:0 0 6px 0;">
            ${escapeHtml(topic || "Sin tema")}
            <span style="opacity:.65;font-size:12px;">(${escapeHtml(specialty)})</span>
          </h3>
          <p class="panel-subtitle" style="margin:0;">
            QID: <code>${escapeHtml(id)}</code> · ExamID: <code>${escapeHtml(examId)}</code> · Preguntas: <strong>${questionsArr.length}</strong>
          </p>
        </div>
      </div>

      <div class="flex-row" style="justify-content:flex-end;">
        <button class="btn btn-outline btn-sm bank-btn-edit">Editar</button>
        <button class="btn btn-primary btn-sm bank-btn-save hidden">Guardar</button>
      </div>
    </div>

    <div style="margin-top:10px;">
      <label class="field">
        <span>Tema (topic)</span>
        <input class="bank-topic-input" type="text" value="${escapeHtml(topic)}" disabled />
      </label>

      <label class="field" style="margin-top:8px;">
        <span>Especialidad</span>
        <input class="bank-specialty-input" type="text" value="${escapeHtml(specialty)}" disabled />
      </label>

      <label class="field" style="margin-top:8px;">
        <span>CaseText</span>
        <textarea class="bank-casetext" rows="5" disabled>${escapeHtml(caseText)}</textarea>
      </label>

      <details style="margin-top:8px;">
        <summary style="cursor:pointer;">Ver/editar preguntas (${questionsArr.length})</summary>
        <textarea class="bank-questions-json" rows="10" disabled>${escapeHtml(JSON.stringify(questionsArr, null, 2))}</textarea>
        <p class="panel-subtitle" style="margin-top:6px;">
          Este JSON debe conservar la estructura: questionText, optionA-D, correctOption, justification, difficulty, subtype.
        </p>
      </details>
    </div>
  `;

  // Handlers
  const checkbox = card.querySelector(".bank-select");
  checkbox.addEventListener("change", () => {
    if (checkbox.checked) bankState.selected.set(id, data);
    else bankState.selected.delete(id);
    updateBankSelectionUI();
  });

  const btnEdit = card.querySelector(".bank-btn-edit");
  const btnSave = card.querySelector(".bank-btn-save");

  btnEdit.addEventListener("click", () => {
    setBankCardEditable(card, true);
    btnSave.classList.remove("hidden");
  });

  btnSave.addEventListener("click", async () => {
    await saveBankCard(card, id);
    setBankCardEditable(card, false);
    btnSave.classList.add("hidden");
  });

  return card;
}

function setBankCardEditable(card, editable) {
  card.querySelector(".bank-topic-input").disabled = !editable;
  card.querySelector(".bank-specialty-input").disabled = !editable;
  card.querySelector(".bank-casetext").disabled = !editable;
  card.querySelector(".bank-questions-json").disabled = !editable;
}

function updateBankSelectionUI() {
  const btn = $("admin-bank-btn-add-to-mini");
  const n = bankState.selected.size;
  btn.disabled = n === 0;
  btn.textContent = n === 0
    ? "Agregar seleccionados a Mini exámenes"
    : `Agregar ${n} seleccionados a Mini exámenes`;
}

async function saveBankCard(card, id) {
  const topic = (card.querySelector(".bank-topic-input").value || "").trim();
  const specialty = (card.querySelector(".bank-specialty-input").value || "").trim();
  const caseText = (card.querySelector(".bank-casetext").value || "").trim();
  const qJson = (card.querySelector(".bank-questions-json").value || "").trim();

  let questionsArr = [];
  try {
    questionsArr = JSON.parse(qJson);
    if (!Array.isArray(questionsArr)) throw new Error("questions no es arreglo");
  } catch (err) {
    toast("El JSON de preguntas no es válido. No se guardó.\n" + err.message);
    return;
  }

  try {
    await updateDoc(doc(db, "questions", id), {
      topic,
      specialty,
      caseText,
      questions: questionsArr,
      updatedAt: serverTimestamp(),
    });

    toast("Caso actualizado correctamente.");

    // actualiza cache selección si estaba seleccionado
    if (bankState.selected.has(id)) {
      bankState.selected.set(id, { ...(bankState.selected.get(id) || {}), topic, specialty, caseText, questions: questionsArr });
    }
  } catch (err) {
    console.error(err);
    toast("Error al guardar en Firestore. Revisa consola.");
  }
}

async function addSelectedBankCasesToMini() {
  const selectedIds = Array.from(bankState.selected.keys());
  if (!selectedIds.length) return;

  const ok = confirm(`Se copiarán ${selectedIds.length} casos a miniQuestions.\n¿Continuar?`);
  if (!ok) return;

  try {
    let created = 0;

    for (const qid of selectedIds) {
      const data = bankState.selected.get(qid);
      if (!data) continue;

      await addDoc(collection(db, "miniQuestions"), {
        caseText: data.caseText || "",
        specialty: data.specialty || null,
        topic: data.topic || "",
        questions: Array.isArray(data.questions) ? data.questions : [],
        sourceQuestionId: qid,          // ✅ trazabilidad
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
      });

      created++;
    }

    toast(`Listo. Se copiaron ${created} casos a miniQuestions.`);
    bankState.selected.clear();
    updateBankSelectionUI();

    // Refresca panel mini si está abierto
    await loadMiniBank();
  } catch (err) {
    console.error(err);
    toast("Error copiando a miniQuestions. Revisa consola.");
  }
}

</html>
