<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Estudiante ENARM Simulacros</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    import {
      getFirestore,
      doc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDAGsmp2qwZ2VBBKIDpUF0NUElcCLsGanQ",
      authDomain: "simulacros-plataforma-enarm.firebaseapp.com",
      projectId: "simulacros-plataforma-enarm",
      storageBucket: "simulacros-plataforma-enarm.firebasestorage.app",
      messagingSenderId: "1012829203040",
      appId: "1:1012829203040:web:71de568ff8606a1c8d7105"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ELEMENTOS
    const loginBtn = document.getElementById("btn-login");
    const emailInput = document.getElementById("email");
    const passInput = document.getElementById("password");

    const landingText = document.getElementById("landing-text");
    const priceMonthlyBox = document.getElementById("price-monthly");
    const priceFullBox = document.getElementById("price-full");

    // Whatsapp
    const PHONE = "+525515656316";

    function whatsRedirect(message) {
      const url = `https://wa.me/${PHONE}?text=${encodeURIComponent(message)}`;
      window.open(url, "_blank", "noopener,noreferrer");
    }

    // Cargar texto y precios desde Firestore
    async function loadLandingPage() {
      try {
        const snap = await getDoc(doc(db, "settings", "landingPage"));
        if (!snap.exists()) return;

        const data = snap.data();

        landingText.innerHTML = data.description || "";

        priceMonthlyBox.innerHTML = `
          <div class="price-title">Precio mensual</div>
          <div class="price-number">$${data.priceMonthly || "0"}</div>
        `;

        priceFullBox.innerHTML = `
          <div class="price-title">Acceso hasta ENARM 2026</div>
          <div class="price-number">$${data.priceFull || "0"}</div>
        `;

      } catch (err) {
        console.error("Error cargando landingPage", err);
      }
    }

    loadLandingPage();

    // CLICK EN PRECIOS
    priceMonthlyBox.addEventListener("click", () => {
      whatsRedirect("Hola, deseo adquirir la plataforma Estudiante ENARM en modalidad mensual.");
    });

    priceFullBox.addEventListener("click", () => {
      whatsRedirect("Hola, deseo adquirir la plataforma Estudiante ENARM con acceso hasta la aplicación del ENARM 2026.");
    });

    // LOGIN
    loginBtn.addEventListener("click", () => {
      const email = emailInput.value.trim();
      const pass = passInput.value.trim();

      if (!email || !pass) {
        alert("Ingresa correo y contraseña.");
        return;
      }

      signInWithEmailAndPassword(auth, email, pass)
        .then(() => {
          // Redirige según rol
          onAuthStateChanged(auth, async (user) => {
            if (!user) return;

            const userRef = doc(db, "users", user.email);
            const snap = await getDoc(userRef);

            if (!snap.exists()) {
              alert("Usuario no registrado en Firestore.");
              return;
            }

            const data = snap.data();
            if (data.role === "admin") {
              window.location.href = "admin.html";
            } else {
              window.location.href = "student.html";
            }
          });
        })
        .catch((err) => {
          console.error(err);
          alert("Correo o contraseña incorrectos.");
        });
    });

    // PRUEBA GRATUITA
    document.getElementById("btn-free").addEventListener("click", () => {
      window.location.href = "free.html";
    });

  </script>
</head>

<body>

  <div id="login-view">

    <div class="login-title-top">
      <img src="logo.png" class="login-logo">
      <h1 class="login-main-title">Estudiante ENARM SIMULACROS</h1>
    </div>

    <div class="login-card">

      <h2 class="login-card-title">Acceso</h2>

      <div class="field">
        <span>Correo electrónico</span>
        <input id="email" type="email">
      </div>

      <div class="field">
        <span>Contraseña</span>
        <input id="password" type="password">
      </div>

      <button id="btn-login" class="btn btn-primary" style="width:100%;">Entrar</button>

      <button id="btn-free" class="btn btn-outline" style="margin-top:14px;width:100%;">Prueba gratuita</button>

    </div>

    <!-- RECUADRO DINÁMICO -->
    <div id="landing-info-box">
      <div id="landing-text"></div>

      <div class="prices-box">
        <div id="price-monthly" class="price-card"></div>
        <div id="price-full" class="price-card"></div>
      </div>
    </div>

  </div>

</body>
</html>
